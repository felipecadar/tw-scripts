Simulator = {
    _unitsStats: {
        "spear": {
            "name": "spear",
            "building": "barracks",
            "required_level": 1,
            "wood": 50,
            "clay": 30,
            "iron": 20,
            "food": 1,
            "build_time": 840,
            "attack": 10,
            "def_inf": 25,
            "def_kav": 45,
            "def_arc": 10,
            "speed": 14,
            "load": 25,
            "type": 1,
            "points_att": 1,
            "points_def": 4
        },
        "sword": {
            "name": "sword",
            "building": "barracks",
            "required_level": 3,
            "wood": 30,
            "clay": 30,
            "iron": 70,
            "food": 1,
            "build_time": 1200,
            "attack": 25,
            "def_inf": 55,
            "def_kav": 5,
            "def_arc": 30,
            "speed": 18,
            "load": 15,
            "type": 1,
            "points_att": 2,
            "points_def": 5
        },
        "axe": {
            "name": "axe",
            "building": "barracks",
            "required_level": 5,
            "wood": 60,
            "clay": 30,
            "iron": 40,
            "food": 1,
            "build_time": 1320,
            "attack": 45,
            "def_inf": 10,
            "def_kav": 5,
            "def_arc": 10,
            "speed": 14,
            "load": 10,
            "type": 1,
            "points_att": 4,
            "points_def": 1
        },
        "archer": {
            "name": "archer",
            "building": "barracks",
            "required_level": 9,
            "wood": 80,
            "clay": 30,
            "iron": 60,
            "food": 1,
            "build_time": 1500,
            "attack": 25,
            "def_inf": 10,
            "def_kav": 30,
            "def_arc": 60,
            "speed": 14,
            "load": 10,
            "type": 3,
            "points_att": 2,
            "points_def": 5
        },
        "light_cavalry": {
            "name": "light_cavalry",
            "building": "barracks",
            "required_level": 11,
            "wood": 125,
            "clay": 100,
            "iron": 250,
            "food": 4,
            "build_time": 1800,
            "attack": 130,
            "def_inf": 30,
            "def_kav": 40,
            "def_arc": 30,
            "speed": 8,
            "load": 80,
            "type": 2,
            "points_att": 13,
            "points_def": 5
        },
        "mounted_archer": {
            "name": "mounted_archer",
            "building": "barracks",
            "required_level": 13,
            "wood": 250,
            "clay": 100,
            "iron": 150,
            "food": 5,
            "build_time": 2200,
            "attack": 150,
            "def_inf": 40,
            "def_kav": 30,
            "def_arc": 50,
            "speed": 8,
            "load": 50,
            "type": 3,
            "points_att": 12,
            "points_def": 6
        },
        "heavy_cavalry": {
            "name": "heavy_cavalry",
            "building": "barracks",
            "required_level": 21,
            "wood": 200,
            "clay": 150,
            "iron": 600,
            "food": 6,
            "build_time": 3200,
            "attack": 150,
            "def_inf": 200,
            "def_kav": 80,
            "def_arc": 180,
            "speed": 9,
            "load": 50,
            "type": 2,
            "points_att": 15,
            "points_def": 23
        },
        "ram": {
            "name": "ram",
            "building": "barracks",
            "required_level": 15,
            "wood": 300,
            "clay": 200,
            "iron": 200,
            "food": 5,
            "build_time": 4800,
            "attack": 2,
            "def_inf": 20,
            "def_kav": 50,
            "def_arc": 20,
            "speed": 24,
            "load": 0,
            "type": 1,
            "points_att": 8,
            "points_def": 4
        },
        "catapult": {
            "name": "catapult",
            "building": "barracks",
            "required_level": 17,
            "wood": 320,
            "clay": 400,
            "iron": 100,
            "food": 8,
            "build_time": 7200,
            "attack": 100,
            "def_inf": 100,
            "def_kav": 50,
            "def_arc": 100,
            "speed": 24,
            "load": 0,
            "type": 1,
            "points_att": 10,
            "points_def": 12
        },
        "knight": {
            "name": "knight",
            "building": "statue",
            "required_level": 1,
            "wood": 0,
            "clay": 0,
            "iron": 0,
            "food": 1,
            "build_time": 21600,
            "attack": 150,
            "def_inf": 250,
            "def_kav": 400,
            "def_arc": 150,
            "speed": 8,
            "load": 100,
            "type": 2,
            "points_att": 20,
            "points_def": 40
        },
        "snob": {
            "name": "snob",
            "building": "academy",
            "required_level": 1,
            "wood": 40000,
            "clay": 50000,
            "iron": 50000,
            "food": 100,
            "build_time": 10800,
            "attack": 30,
            "def_inf": 100,
            "def_kav": 50,
            "def_arc": 100,
            "points_att": 200,
            "points_def": 200,
            "speed": 35,
            "load": 0,
            "type": 1,
            "special": 1
        },
        "trebuchet": {
            "name": "trebuchet",
            "building": "preceptory",
            "required_level": 1,
            "wood": 4000,
            "clay": 2000,
            "iron": 2000,
            "food": 10,
            "build_time": 1800,
            "attack": 30,
            "def_inf": 200,
            "def_kav": 250,
            "def_arc": 200,
            "points_att": 0,
            "points_def": 25,
            "speed": 50,
            "load": 0,
            "type": 1,
            "special": 1
        },
        "doppelsoldner": {
            "name": "doppelsoldner",
            "building": "preceptory",
            "required_level": 1,
            "wood": 1200,
            "clay": 1200,
            "iron": 2400,
            "food": 6,
            "build_time": 1800,
            "attack": 300,
            "def_inf": 100,
            "def_kav": 100,
            "def_arc": 50,
            "points_att": 25,
            "points_def": 10,
            "speed": 14,
            "load": 10,
            "type": 1,
            "special": 1
        }
    },
    _unitToAttackType: {
        spear: "attack",
        sword: "attack",
        axe: "attack",
        ram: "attack",
        catapult: "attack",
        snob: "attack",
        trebuchet: "attack",
        doppelsoldner: "attack",
        light_cavalry: "attack_cavalry",
        heavy_cavalry: "attack_cavalry",
        knight: "attack_cavalry",
        archer: "attack_archer",
        mounted_archer: "attack_archer",
    },
    _attackTypeToUnits: {
        attack: ["spear", "sword", "axe", "ram", "catapult", "snob", "trebuchet", "doppelsoldner"],
        attack_cavalry: ["light_cavalry", "heavy_cavalry", "knight"],
        attack_archer: ["archer", "mounted_archer"]
    },
    _getAttackSum: function (units, attackBonus) {
        attackBonus = attackBonus || {};
        var sum = {
            attack: 0,
            attack_cavalry: 0,
            attack_archer: 0
        };
        console.log(attackBonus);
        for (var unit in units) {
            var bonus = attackBonus[unit] || 1;
            sum[this._unitToAttackType[unit]] += this._unitsStats[unit].attack * units[unit] * bonus;
        }
        return sum;
    },
    _getAttackFoodSum: function (units) {
        var sum = {
            attack: 0,
            attack_cavalry: 0,
            attack_archer: 0
        };
        for (var unit in units) {
            sum[this._unitToAttackType[unit]] += this._unitsStats[unit].food * units[unit];
        }
        return sum;
    },
    _getDefendSum: function (units) {
        var sum = {
            defense: 0,
            defense_cavalry: 0,
            defense_archer: 0
        };
        for (var unit in units) {
            sum.defense += this._unitsStats[unit].def_inf * units[unit];
            sum.defense_cavalry += this._unitsStats[unit].def_kav * units[unit];
            sum.defense_archer += this._unitsStats[unit].def_arc * units[unit];
        }
        return sum;
    },
    _getSum: function (object) {
        var sum = 0;
        for (var key in object) {
            sum += Math.round(object[key]);
        }
        return sum;
    },
    _calcResultingWall: function (rammen, wall, glaubensbonus, morgenstern) {
        rammen = rammen || 0;
        wall = wall || 0;
        morgenstern = (morgenstern) ? 2 : 1;
        return Math.max(
            wall - Math.round((rammen * glaubensbonus * morgenstern) / (4 * Math.pow(1.09, wall))),
            Math.round(wall / (2 * morgenstern))
        );
    },
    _calcWallAfterFight: function (attacker, defender, wall, glaubensbonus, morgenstern) {
        var resultingWall = 0;
        rammen = attacker.quantity.ram || 0;
        wall = wall || 0;
        morgenstern = (morgenstern) ? 2 : 1;

        if (rammen === 0 || wall === 0)
            return wall;

        var loseRateDefender = this._getSum(defender.losses) / this._getSum(defender.quantity);
        if (loseRateDefender === 1 || isNaN(loseRateDefender)) {
            //attacker wins
            var loseRateAttacker = this._getSum(attacker.losses) / this._getSum(attacker.quantity);
            var maxDamage = (rammen * this._unitsStats.ram.attack * glaubensbonus * morgenstern) / (4 * Math.pow(1.09, wall));
            resultingWall = wall - Math.round(maxDamage - 0.5 * maxDamage * loseRateAttacker);
        } else {
            //defender wins
            resultingWall = wall - Math.round(rammen * this._unitsStats.ram.attack * glaubensbonus * morgenstern * loseRateDefender / (8 * Math.pow(1.09, wall)));
        }
        return Math.max(0, resultingWall);
    },
    simulate: function (attackerUnits, defenderUnits, wall, nightbonus, moral, luck, unglaeubigAngreifer, unglaeubigVerteidiger, palaItems) {
        var glaubensbonus = (unglaeubigAngreifer ? 0.5 : 1) * (unglaeubigVerteidiger ? 2 : 1);
        wall = wall || 0;
        moral = moral || 100;
        moral /= 100;
        luck = luck || 0;
        luck = 1 + luck / 100;
        nightbonus = (nightbonus) ? 2 : 1;
        palaItems = palaItems || [];
        var attacker = {
            quantity: {},
            losses: {},
        };
        var defender = {
            quantity: {},
            losses: {},
        };
        var foodAttacker = 0;
        var foodDefender = 0;
        for (var unit in this._unitsStats) {
            attacker.quantity[unit] = attackerUnits[unit] = attackerUnits[unit] || 0;
            defender.quantity[unit] = defenderUnits[unit] = defenderUnits[unit] || 0;
            foodAttacker += attacker.quantity[unit] * this._unitsStats[unit].food;
            foodDefender += defender.quantity[unit] * this._unitsStats[unit].food;
        }
        var attackBonus = {};
        if (foodAttacker < foodDefender / 2) {
            //berserker werden doppelt so stark. danke an Felix
            attackBonus['doppelsoldner'] = 2;
        }
        console.log(foodAttacker, foodDefender, attackBonus);

        var resultingWall = this._calcResultingWall(attackerUnits.ram, wall, glaubensbonus, palaItems.indexOf('morgenstern') !== -1);
        var wallBonus = 1 + resultingWall * 0.05;
        if (resultingWall === 0) {
            var wallDefense = 0;
        } else {
            var wallDefense = Math.round(Math.pow(1.24, resultingWall) * 20);
        }



        do {
            var attackStrength = this._getAttackSum(attackerUnits, attackBonus);
            var defendStrength = this._getDefendSum(defenderUnits);
            var attackSum = this._getSum(attackStrength);

            var attackFood = this._getAttackFoodSum(attackerUnits);
            var attackFoodSum = this._getSum(attackFood);


            var defenderUnitsCopy = {};
            for (var unit in this._unitsStats) {
                defenderUnitsCopy[unit] = defenderUnits[unit];
            }
            for (var attackType in attackStrength) {
                if (attackStrength[attackType] === 0)
                    continue;
                var ratio = attackFood[attackType] / attackFoodSum;
                var defense = defendStrength[attackType.replace('attack', 'defense')] * ratio * wallBonus * nightbonus + wallDefense * ratio;
                var a = attackStrength[attackType] * moral * luck * glaubensbonus / defense;
                if (a < 1) {
                    var c = Math.sqrt(a) * a;
                    for (var unit in defenderUnits) {
                        defenderUnits[unit] -= defenderUnitsCopy[unit] * c * ratio;
                    }
                    for (var i in this._attackTypeToUnits[attackType]) {
                        var unit = this._attackTypeToUnits[attackType][i];
                        attackerUnits[unit] = 0;
                    }
                } else {
                    var c = Math.sqrt(1 / a) / a;
                    for (var unit in defenderUnits) {
                        defenderUnits[unit] -= ratio * defenderUnitsCopy[unit];
                    }
                    for (var i in this._attackTypeToUnits[attackType]) {
                        var unit = this._attackTypeToUnits[attackType][i];
                        attackerUnits[unit] -= c * attackerUnits[unit];
                    }
                }
            }
        } while (this._getSum(attackerUnits) >= 1 && this._getSum(defenderUnits) >= 1);




        for (var unit in this._unitsStats) {
            attacker.losses[unit] = attacker.quantity[unit] - Math.round((attackerUnits[unit] || 0));
            defender.losses[unit] = defender.quantity[unit] - Math.round((defenderUnits[unit] || 0));
        }

        return {
            attacker: attacker,
            defender: defender,
            wallAfter: this._calcWallAfterFight(attacker, defender, wall, glaubensbonus, palaItems.indexOf('morgenstern') !== -1),
            wallBefore: wall
        };
    }
}

TW2.ready(function (data) {
    Simulator._unitsStats = data.units;
});




















































function getSimulatorInput() {
    var result = {
        asString: {
            attackUnits: {},
            defendUnits: {}
        },
        asInteger: {
            attackUnits: {},
            defendUnits: {}
        }
    };
    var inputs = document.getElementById('units').getElementsByTagName('input');
    var i = 0;
    var inputOrder = ['spear', 'sword', 'axe', 'archer', 'light_cavalry', 'mounted_archer', 'heavy_cavalry', 'ram', 'catapult', 'doppelsoldner', 'trebuchet', 'snob', 'knight'];
    for (var j = 0; j < inputOrder.length; j++) {
        var unit = inputOrder[j];
        result.asString.attackUnits[unit] = inputs[i].value;
        result.asString.defendUnits[unit] = inputs[i + 1].value;
        result.asInteger.attackUnits[unit] = +inputs[i].value > 0 ? +inputs[i].value : 0;
        result.asInteger.defendUnits[unit] = +inputs[i + 1].value > 0 ? +inputs[i + 1].value : 0;
        i += 2;
    }

    result.asInteger.night = result.asString.night = document.getElementById('night').checked;
    result.asInteger.unglaeubigAngreifer = result.asString.unglaeubigAngreifer = !document.getElementById('beliefAttacker').checked;
    result.asInteger.unglaeubigVerteidiger = result.asString.unglaeubigVerteidiger = !document.getElementById('beliefDefender').checked;

    result.asString.wall = document.getElementById('wall').value;
    result.asInteger.wall = +result.asString.wall > 0 ? +result.asString.wall : 0;

    result.asString.moral = document.getElementById('moral').value;
    result.asInteger.moral = +result.asString.moral > 0 ? +result.asString.moral : 0;

    result.asString.luck = document.getElementById('luck').value;
    result.asInteger.luck = +result.asString.luck + 26 > 0 ? +result.asString.luck : 0;

    return result;
}
/*
function setSimulatorInput(units){
    units.attackUnits = units.attackUnits || {};
    units.defendUnits = units.defendUnits || {};
    var trs = simulator_units_table.getElementsByTagName('tr');
    var i = 0;
    for(var unit in Simulator._unitsStats){
        var inputs = trs[i].getElementsByTagName('input');
        inputs[i + 0].value = units.attackUnits[unit] || '';
        inputs[i + 1].value = units.defendUnits[unit] || '';
        i += 2;
    }
    document.getElementById('wall').value = units['wall'] || '';
    document.getElementById('moral').value = units['moral'] || '';
    document.getElementById('luck').value = units['luck'] || '';
    document.getElementById('night').checked = units['night'] || false;
}*/

function insertSurvivingUnits() {
    var simulatorInput = getSimulatorInput();
    var s = simulatorInput.asInteger;
    var result = Simulator.simulate(s.attackUnits, s.defendUnits, s.wall, s.night, s.moral, s.luck, s.unglaeubigAngreifer, s.unglaeubigVerteidiger, s.items);

    var inputs = document.getElementById('units').getElementsByTagName('input');
    var i = 0;
    var inputOrder = ['spear', 'sword', 'axe', 'archer', 'light_cavalry', 'mounted_archer', 'heavy_cavalry', 'ram', 'catapult', 'doppelsoldner', 'trebuchet', 'snob', 'knight'];
    for (var j = 0; j < inputOrder.length; j++) {
        var unit = inputOrder[j];
        inputs[i + 1].value = result.defender.quantity[unit] - result.defender.losses[unit];
        i += 2;
    }
    document.getElementById('wall').value = result.wallAfter;
}


function setSimulatorResult(result) {
    var simulation_result = document.getElementById('simulation_result');
    var divs = simulation_result.getElementsByTagName('div');
    var i = 3;
    var inputOrder = ['spear', 'sword', 'axe', 'archer', 'light_cavalry', 'mounted_archer', 'heavy_cavalry', 'ram', 'catapult', 'doppelsoldner', 'trebuchet', 'snob', 'knight'];
    for (var j = 0; j < inputOrder.length; j++) {
        var unit = inputOrder[j];
        divs[i].innerHTML = result.attacker.quantity[unit];
        divs[i + 1].innerHTML = result.attacker.losses[unit];
        i += 2;
    }
    i += 3;
    var inputOrder = ['spear', 'sword', 'axe', 'archer', 'light_cavalry', 'mounted_archer', 'heavy_cavalry', 'ram', 'catapult', 'doppelsoldner', 'trebuchet', 'snob', 'knight'];
    for (var j = 0; j < inputOrder.length; j++) {
        var unit = inputOrder[j];
        divs[i].innerHTML = result.defender.quantity[unit];
        divs[i + 1].innerHTML = result.defender.losses[unit];
        i += 2;
    }

    if (result.wallBefore !== result.wallAfter) {
        document.getElementById('ramdamage').style.display = '';
        document.getElementById('wallfrom').innerHTML = result.wallBefore;
        document.getElementById('wallto').innerHTML = result.wallAfter;
    } else {
        document.getElementById('ramdamage').style.display = 'none';
    }

    simulation_result.style.display = '';
    document.getElementById('button_insert_surviving_units').style.display = '';
}

//global elements

function simulate() {
    var simulatorInput = getSimulatorInput();
    //location.hash = JSON.stringify(simulatorInput.asString);
    var s = simulatorInput.asInteger;
    var result = Simulator.simulate(s.attackUnits, s.defendUnits, s.wall, s.night, s.moral, s.luck, s.unglaeubigAngreifer, s.unglaeubigVerteidiger, s.items);
    setSimulatorResult(result);
}
var inputs = document.getElementsByClassName('unit-input-simulator');
for (var i = 0; i < inputs.length; i++) {
    inputs[i].addEventListener('input', simulate);
}
document.getElementById('night').addEventListener('change', simulate);
document.getElementById('beliefAttacker').addEventListener('change', simulate);
document.getElementById('beliefDefender').addEventListener('change', simulate);

document.getElementById('button_insert_surviving_units').addEventListener('click', function (e) {
    e.preventDefault();
    insertSurvivingUnits();
    simulate();
});

/*
try{
    setSimulatorInput(JSON.parse(location.hash.substring(1)));
    updateBauernhof();
}catch(e){
    console.log(e);
}
*/

